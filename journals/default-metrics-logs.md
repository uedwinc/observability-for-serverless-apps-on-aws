# Exploring default metrics and logs

Let’s look at the default out-of-the-box metrics and logs available when you deploy an application on AWS Lambda.

## Built-in metrics

Lambda comes with 15 default metrics (please visit https://docs.aws.amazon.com/lambda/latest/dg/monitoring-metrics.html for more information) divided into three categories: `Invocation metrics`, `Performance metrics`, and `Concurrency metrics`.

Some of the important Lambda metrics are `Invocations`, `Errors`, `Throttles`, `Duration`, and `ConcurrentExecutions`. You can create a widget with the important metrics as shown here:

![lambda-default-1](/images/lambda-default-1.png)
![lambda-default-2](/images/lambda-default-2.png)

To fully understand the performance of Lambda functions, it is crucial to track the `duration of the execution` and `percentile of requests completed within a period` to analyze the performance impact.

Analyzing the P90 metric (the P90 metric provides you with the average duration of execution of less than or equal to 90% of requests executed for a given period), reveals that 50% of requests are processed within 54.8 ms (milliseconds), 90% within 379 ms, and 95% within 383 ms. 

![p-metric](/images/p-metric.png)

These statistics provide valuable insights and can guide you toward optimizing the function’s configuration for improved performance.

Now that we have explored the default metrics generated by AWS Lambda in CloudWatch, let’s explore the default logging being provided in AWS Lambda when the out-of-the-box logging feature is enabled.

## Lambda logging

When you deploy a Lambda function, logging is enabled by default. It provide logs for every execution with information about billed duration, memory use, and memory configured.

To verify the logs generated due to Lambda invocation, you can navigate to `CloudWatch` | `Logs` | `Log groups` and verify the log group name starting with `/aws/lambda/serverless-app-getAllItemsFunction-%%%%`. The last few characters are randomly generated. You can select the log stream to view the logs generated by the Lambda function.

![log-groups](/images/log-groups.png)
![log-group-events](/images/log-groups-events.png)

## CloudWatch Logs Insights from Lambda logs

You could derive operational intelligence from the Lambda logs using `CloudWatch Logs Insights`.

Here is a sample query to estimate the `number of cold starts`, the `average duration of the Lambda function execution`, and `memory usage` grouped by a 5-minute time period:

```
filter @type = "REPORT"
| stats
  count(@type) as countInvocations ,
  count(@initDuration) as countColdStarts ,(count(@initDuration)/
count(@type))*100 as percentageColdStarts,
  max(@initDuration) as maxColdStartTime,
  avg(@duration) as averageDuration,
  max(@duration) as maxDuration,
  min(@duration) as minDuration,
  avg(@maxMemoryUsed) as averageMemoryUsed,
  max(@memorySize) as memoryAllocated, (avg(@maxMemoryUsed)/max(@memorySize))*100 as percentageMemoryUsed
by bin(5m) as timeFrame
```

The output of this code, when executed, will provide a view as follows:

![query-output](/images/query-output.png)

To see the important metrics in a unified dashboard, let’s create a CloudWatch dashboard for this custom application, for metrics generated from the API Gateway, Lambda functions, and DynamoDB.

![unified-dash](/images/unified-dash.png)

## API Gateway metrics and logs

AWS API Gateway provides several default metrics that include `Latency`, `Count`, `Integration Latency`, `4XX Error`, and `5XX Error`. To assess the impact of including API Gateway in the overall solution, it’s important to observe the difference between the `Latency metric` and the `Integration Latency metric`. This difference represents the extra overhead added to the application performance because of including API Gateway in the architecture.

API Gateway allows you to log two types of logs: `API Gateway execution logs` and `API Gateway access logs`.

  - API Gateway execution logs can have three different logging levels: namely `errors only`, `error and info logs`, and `full request and response logs`. You can set logging globally for the entire API Gateway or in different stages of API Gateway.

  - API Gateway access logs provide a comprehensive view of who is accessing the API including information such as `IP`, `HttpMethod`, `User`, `Protocol`, and `Time`. These logs provide valuable insights into the origin of API Gateway invocations.

> Note:
> We have not enabled logging in the CloudFormation template for this exercise, and it should be done manually, as shown below:

1. Go to `API Gateway` | `APIs` | `serverless-app***` | `Stages`
2. Select the `Prod` stage and click `Edit` for `Logs and tracing`
3. Edit appropriately as shown below and click `Save`:

![API-Gateway-Edit-logs-and-tracing](/images/API-Gateway-Edit-logs-and-tracing.png)

Here's the log format used:

```
{"requestId": "$context.requestId", "ip": "$context.identity.sourceIp", "caller": "$context.identity.caller", "user": "$context.identity.user", "requestTime": "$context.requestTime", "httpMethod": "$context.httpMethod", "resourcePath": "$context.resourcePath", "status": "$context.status", "protocol": "$context.protocol", "responseLength": "$context.responseLength"}
```

Reference doc: https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html

4. You will first need to create an IAM role for logging to CloudWatch and add the IAM role in the API Gateway console settings for CloudWatch log role ARN.

> Follow instructions in this blog post: https://cloudnamaste.com/api-gateway-cloudwatch-logs/

Relying solely on the built-in metrics for API Gateway and Lambda function(s) presents difficulties in understanding the performance issues related to the Lambda functions – for example, network performance and cold starts. Although we can estimate the count of cold starts from logs, we can achieve a more comprehensive understanding of performance through `Lambda Insights`.